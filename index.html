<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WIN BINGO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --joy-purple: #8e44ad; --joy-orange: #f39c12; --joy-bg: #f3e5f5; --joy-green: #27ae60; --joy-red: #e74c3c; 
            --b-col: #f1c40f; --i-col: #27ae60; --n-col: #2980b9; --g-col: #c0392b; --o-col: #8e44ad; 
        }
        body { background: var(--joy-bg); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        #offline-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center; padding: 20px;
        }

        #selection-header {
            display: flex; justify-content: space-around; align-items: center;
            background-color: white; width: 96%; margin: 10px auto;
            padding: 10px 0; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid #ce93d8;
            z-index: 2100;
        }
        .header-stat { text-align: center; flex: 1; border-right: 1px solid #eee; }
        .header-stat:last-child { border-right: none; }
        .stat-label { font-size: 10px; color: #9c27b0; font-weight: bold; text-transform: uppercase; }
        .stat-value { font-size: 18px; font-weight: bold; color: #333; }
        .timer-value { color: #e74c3c; font-size: 24px; }

        #selection-screen { position: fixed; inset: 0; background: var(--joy-bg); z-index: 2000; display: flex; flex-direction: column; padding-top: 80px; }
        .sel-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding-bottom: 220px; }
        .card-opt { background: white; padding: 12px; text-align: center; border-radius: 8px; font-weight: bold; border: 1px solid #ccc; font-size: 14px; transition: 0.2s; }
        .card-opt.active { background: var(--joy-orange); color: white; border-color: white; transform: scale(1.05); }

        .preview-pane { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 210px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top: 2px solid #ddd; z-index: 2100; }
        .mini-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; width: 140px; background: #eee; padding: 3px; border-radius: 4px; }
        .mini-cell { aspect-ratio: 1; background: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 0.5px solid #ddd; }
        .mini-cell.f-space { background: var(--joy-green); color: white; }

        .header-stats { display: grid; grid-template-columns: repeat(5, 1fr); background: white; padding: 6px; text-align: center; font-size: 10px; border-bottom: 1px solid #eee; }
        .stat-val { font-weight: bold; color: var(--joy-purple); display: block; font-size: 13px; }
        
        .history-bar { background: white; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; border-bottom: 2px solid #ddd; }
        .curr-call-box { background: var(--joy-purple); color: white; border-radius: 50px; padding: 5px 15px; display: flex; align-items: center; gap: 10px; height: 44px; flex-shrink: 0; }
        .big-ball { background: var(--joy-orange); width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; font-size: 16px; }
        
        .hist-balls { display: flex; gap: 5px; flex: 1; justify-content: flex-end; }
        .small-ball { background: #ffd085; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #7a4a00; font-weight: bold; border: 1px solid #f39c12; }

        .game-body { display: flex; flex: 1; padding: 8px; gap: 8px; box-sizing: border-box; overflow: hidden; }
        .master-side { width: 45%; display: flex; flex-direction: column; }
        .player-side { width: 55%; display: flex; flex-direction: column; align-items: center; gap: 4px; }

        .letter-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; width: 100%; }
        .letter { aspect-ratio: 1.2; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border-radius: 4px 4px 0 0; color: white; }
        .col-b { background: var(--b-col); }
        .col-i { background: var(--i-col); }
        .col-n { background: var(--n-col); }
        .col-g { background: var(--g-col); }
        .col-o { background: var(--o-col); }

        .grid-main { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; background: white; padding: 4px; border-radius: 0 0 8px 8px; width: 100%; box-sizing: border-box; }
        .m-grid { flex: 1; grid-template-rows: repeat(15, 1fr); grid-auto-flow: column; }
        .m-cell { background: #f8f8f8; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 1px solid #eee; }
        .m-cell.on { background: var(--joy-orange); color: white; }

        .p-cell { aspect-ratio: 1; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; border-radius: 4px; }
        .p-cell.hit { background: var(--joy-green); color: white; }
        
        .bingo-btn { height: 50px; background: #ccc; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 22px; width: 100%; pointer-events: none; margin-top: 5px; }
        .bingo-btn.on { background: var(--joy-green); pointer-events: auto; box-shadow: 0 0 15px var(--joy-green); }
        
        #win-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .win-card { background:white; border-radius:15px; width:100%; max-width:300px; text-align:center; overflow:hidden; }
        .reset-btn { background: var(--joy-purple); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 15px; width: 100%; cursor: pointer; }

        .sound-test-btn { background: #e1f5fe; color: #0288d1; border: 1px solid #0288d1; padding: 5px 10px; border-radius: 20px; font-size: 10px; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="offline-overlay">
        <h2>No Connection</h2>
        <p>Please reconnect to continue the game.</p>
    </div>

    <div id="selection-header">
        <div class="header-stat"><div id="timer" class="stat-value timer-value">--</div></div>
        <div class="header-stat"><div class="stat-label">Wallet</div><div id="wallet-bal" class="stat-value">0</div></div>
        <div class="header-stat"><div class="stat-label">Stake</div><div class="stat-value">10</div></div>
        <div class="header-stat"><div class="stat-label">Game â„–</div><div class="stat-value">1 of 1</div></div>
    </div>

    <div id="selection-screen">
        <div class="sel-grid" id="cardGrid"></div>
        <div class="preview-pane" id="previewPane">
            <p id="previewLabel" style="font-size:11px; margin-bottom:8px; color:#666;">Tap a card to join round</p>
            <div class="mini-grid" id="miniGrid" style="display:none;"></div>
            <button class="sound-test-btn" onclick="testSound()">ðŸ”Š TEST AMHARIC VOICE</button>
        </div>
    </div>

    <div class="header-stats" style="display:none;" id="game-stats-bar">
        <div><span class="stat-val" id="totalDerash">0</span>DERASH</div>
        <div><span class="stat-val" id="activePlayers">0</span>PLAYERS</div>
        <div><span class="stat-val">10</span>BET</div>
        <div><span class="stat-val" id="callCount">0</span>CALL</div>
        <div><span class="stat-val">1 of 1</span>GAME</div>
    </div>

    <div class="history-bar" id="history-section" style="display:none;">
        <div class="curr-call-box">
            <span style="font-size: 11px; font-weight: bold;">Current</span>
            <div class="big-ball" id="currBall">--</div>
        </div>
        <div class="hist-balls" id="last3Row">
            <div class="small-ball">--</div>
            <div class="small-ball">--</div>
            <div class="small-ball">--</div>
        </div>
    </div>

    <div class="game-body" id="main-game-area" style="display:none;">
        <div class="master-side">
            <div class="letter-row">
                <div class="letter col-b">B</div><div class="letter col-i">I</div><div class="letter col-n">N</div><div class="letter col-g">G</div><div class="letter col-o">O</div>
            </div>
            <div class="grid-main m-grid" id="masterGrid"></div>
        </div>
        <div class="player-side" id="playerArea"></div>
    </div>

    <div id="win-modal">
        <div class="win-card">
            <div style="background:var(--joy-orange); color:white; padding:15px; font-size:24px; font-weight:bold;">BINGO!</div>
            <div style="padding:20px;">
                <p id="winMsg" style="font-weight:bold; font-size:18px; color:var(--joy-purple);">WINNER!</p>
                <p style="font-size:15px; margin-top:12px; font-weight:bold;">Prize: <span id="win-amount">0</span> ETB</p>
                <button class="reset-btn" onclick="closeWinModal()">PLAY NEXT ROUND</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let selectedCardId=null, selectedCardData=null, called=[], marked=new Set(), gameActive=false, ballNow=null;
        
        const params = new URLSearchParams(window.location.search);
        let currentBalance = parseInt(params.get('bal')) || 0;
        document.getElementById('wallet-bal').innerText = currentBalance;

        // VOICE LOGIC
        function speakAmharic(num) {
            if (!window.speechSynthesis) return;
            
            // Cancel any current speech to prevent overlapping
            window.speechSynthesis.cancel();

            let letter = (num <= 15) ? "B" : (num <= 30) ? "I" : (num <= 45) ? "N" : (num <= 60) ? "G" : "O";
            let textToSay = `${letter}... ${num}`;
            
            const utterance = new SpeechSynthesisUtterance(textToSay);
            
            // Try to find an Amharic voice specifically
            const voices = window.speechSynthesis.getVoices();
            const amharicVoice = voices.find(v => v.lang.startsWith('am'));
            
            if (amharicVoice) {
                utterance.voice = amharicVoice;
                utterance.lang = 'am-ET';
            } else {
                // If no Amharic voice, use default but slow down for clarity
                utterance.lang = 'en-US';
                utterance.pitch = 0.9;
            }
            
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        function testSound() {
            speakAmharic(15);
            tg.showAlert("If you didn't hear 'B 15', please check your phone's media volume or download the Amharic Voice Pack in Google Settings.");
        }

        // Initialize voices for mobile browsers
        window.speechSynthesis.getVoices();

        function updateSyncTimer() {
            if (gameActive) return;
            const now = new Date();
            const seconds = now.getSeconds();
            let timeLeft = 20 - (seconds % 20);
            document.getElementById('timer').textContent = timeLeft;
            if (timeLeft === 1) {
                setTimeout(() => { if (selectedCardId && !gameActive) startGame(Math.floor(Math.random() * 5) + 2); }, 1000);
            }
        }
        setInterval(updateSyncTimer, 1000);

        function getBingoCard(id) {
            let card = [];
            const seed = id * 1.5; 
            const pseudoRandom = (s) => { let x = Math.sin(s) * 10000; return x - Math.floor(x); };
            for(let col=0; col<5; col++) {
                let range = Array.from({length:15}, (_,n) => (col*15)+n+1);
                for (let i = range.length - 1; i > 0; i--) {
                    const j = Math.floor(pseudoRandom(seed + col + i) * (i + 1));
                    [range[i], range[j]] = [range[j], range[i]];
                }
                card[col] = range.slice(0,5);
            }
            let flat = [];
            for(let row=0; row<5; row++) {
                for(let col=0; col<5; col++) {
                    if(row === 2 && col === 2) flat.push('F');
                    else flat.push(card[col][row]);
                }
            }
            return flat;
        }

        const grid = document.getElementById('cardGrid');
        for(let i=1; i<=200; i++) {
            const d = document.createElement('div'); d.className='card-opt'; d.textContent=i;
            d.onclick=()=>{
                if(gameActive) return;
                document.querySelectorAll('.card-opt').forEach(el=>el.classList.remove('active'));
                d.classList.add('active'); 
                selectedCardId=i;
                selectedCardData = getBingoCard(i);
                showPreview(i);
            };
            grid.appendChild(d);
        }

        function showPreview(id) {
            const mg = document.getElementById('miniGrid');
            mg.style.display = 'grid'; mg.innerHTML = '';
            document.getElementById('previewLabel').textContent = "Card #" + id + " Selected";
            selectedCardData.forEach(n => {
                const c = document.createElement('div');
                c.className = n === 'F' ? 'mini-cell f-space' : 'mini-cell';
                c.textContent = n;
                mg.appendChild(c);
            });
        }

        function startGame(playerCount) {
            gameActive = true;
            currentBalance -= 10;
            document.getElementById('wallet-bal').innerText = currentBalance;
            document.getElementById('selection-header').style.display = 'none';
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('game-stats-bar').style.display = 'grid';
            document.getElementById('history-section').style.display = 'flex';
            document.getElementById('main-game-area').style.display = 'flex';
            document.getElementById('activePlayers').textContent = playerCount;
            document.getElementById('totalDerash').textContent = playerCount * 8;

            const zone = document.getElementById('playerArea');
            zone.innerHTML = `
                <div class="letter-row">
                    <div class="letter col-b">B</div><div class="letter col-i">I</div><div class="letter col-n">N</div><div class="letter col-g">G</div><div class="letter col-o">O</div>
                </div>
                <div class="grid-main" id="pGrid"></div>
                <button class="bingo-btn" id="bingoBtn" onclick="winGame(${playerCount})">BINGO</button>`;

            marked.clear(); called = [];
            selectedCardData.forEach((n,idx)=>{
                const c = document.createElement('div'); c.className = n==='F'?'p-cell hit':'p-cell'; c.textContent=n;
                if(n==='F') marked.add(idx);
                c.onclick = () => { if(called.includes(n)){ c.classList.add('hit'); marked.add(idx); checkWin(); }};
                document.getElementById('pGrid').appendChild(c);
            });
            initMaster(); runLoop();
        }

        function initMaster() {
            const g = document.getElementById('masterGrid'); g.innerHTML = '';
            for(let col=0; col<5; col++) {
                for(let row=1; row<=15; row++) {
                    const num = (col * 15) + row;
                    const d = document.createElement('div'); d.className='m-cell'; d.id='m-'+num; d.textContent=num;
                    g.appendChild(d);
                }
            }
        }

        function runLoop() {
            let pool = Array.from({length:75},(_,i)=>i+1).sort(() => Math.random() - 0.5);
            const ballTimer = setInterval(() => {
                if(!gameActive) { clearInterval(ballTimer); return; }
                ballNow = pool.pop(); called.push(ballNow);
                
                // TRIGGER VOICE
                speakAmharic(ballNow);

                document.getElementById('currBall').textContent = ballNow;
                if(document.getElementById('m-'+ballNow)) document.getElementById('m-'+ballNow).classList.add('on');
                document.getElementById('callCount').textContent = called.length;
                const last3 = called.slice(-4, -1).reverse();
                const histRow = document.getElementById('last3Row');
                histRow.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const b = document.createElement('div'); b.className = 'small-ball';
                    b.textContent = last3[i] || '--';
                    histRow.appendChild(b);
                }
                checkWin();
            }, 4000); 
        }

        function checkWin() {
            const wins = [
                [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24], 
                [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24], 
                [0,6,12,18,24],[4,8,12,16,20],
                [0,4,20,24] 
            ];
            const lastBallOnCard = selectedCardData.includes(ballNow);
            if(wins.find(p => p.every(i => marked.has(i))) && lastBallOnCard) {
                document.getElementById('bingoBtn').classList.add('on');
            }
        }

        function winGame(playerCount) {
            gameActive = false;
            const prize = playerCount * 8;
            currentBalance += prize; 
            const winData = { action: "update_balance", prize: prize, card: selectedCardId };
            tg.sendData(JSON.stringify(winData));
            document.getElementById('win-amount').textContent = prize;
            document.getElementById('win-modal').style.display = 'flex';
        }

        function closeWinModal() {
            document.getElementById('win-modal').style.display = 'none';
            document.getElementById('main-game-area').style.display = 'none';
            document.getElementById('game-stats-bar').style.display = 'none';
            document.getElementById('history-section').style.display = 'none';
            document.getElementById('selection-header').style.display = 'flex';
            document.getElementById('selection-screen').style.display = 'flex';
            document.getElementById('wallet-bal').innerText = currentBalance;
            selectedCardId = null;
            document.querySelectorAll('.card-opt').forEach(el=>el.classList.remove('active'));
            document.getElementById('miniGrid').style.display = 'none';
        }
    </script>
</body>
</html>
